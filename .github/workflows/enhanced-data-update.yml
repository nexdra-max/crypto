name: å¢å¼ºç‰ˆåŠ å¯†è´§å¸æ•°æ®è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡æ•°æ®
    - cron: '0 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/scripts/enhanced-data-fetcher.js'

jobs:
  update-crypto-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm init -y
        npm install axios moment
        
    - name: è¿è¡Œå¢å¼ºç‰ˆæ•°æ®è·å–è„šæœ¬
      env:
        COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œå¢å¼ºç‰ˆæ•°æ®è·å–..."
        node .github/scripts/enhanced-data-fetcher.js
        echo "âœ… æ•°æ®è·å–å®Œæˆ"
        
    - name: æ£€æŸ¥æ•°æ®æ–‡ä»¶
      run: |
        echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶..."
        ls -la data/
        echo "ğŸ“ˆ å¸‚åœºæ•°æ®æ–‡ä»¶å¤§å°:"
        du -h data/enhanced-market-data.json || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        echo "ğŸ¢ äº¤æ˜“æ‰€æ•°æ®æ–‡ä»¶å¤§å°:"
        du -h data/advanced-exchanges.json || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        echo "ğŸ“° æ–°é—»æ•°æ®æ–‡ä»¶å¤§å°:"
        du -h data/smart-news.json || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        echo "ğŸ’° å¥—åˆ©æ•°æ®æ–‡ä»¶å¤§å°:"
        du -h data/advanced-arbitrage.json || echo "æ–‡ä»¶ä¸å­˜åœ¨"
        
    - name: æäº¤æ›´æ–°çš„æ•°æ®
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ•°æ®å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        echo "ğŸ“ æäº¤æ•°æ®æ›´æ–°..."
        git add data/
        git add -A
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ğŸ”„ è‡ªåŠ¨æ›´æ–°åŠ å¯†è´§å¸æ•°æ® - $TIMESTAMP"
        
        # æ·»åŠ æ•°æ®ç»Ÿè®¡åˆ°æäº¤ä¿¡æ¯
        if [ -f "data/comprehensive-report.json" ]; then
          COINS_COUNT=$(grep -o '"total_coins":[0-9]*' data/comprehensive-report.json | grep -o '[0-9]*' || echo "0")
          EXCHANGES_COUNT=$(grep -o '"total_exchanges":[0-9]*' data/comprehensive-report.json | grep -o '[0-9]*' || echo "0")
          COMMIT_MSG="$COMMIT_MSG

ğŸ“Š æ•°æ®ç»Ÿè®¡:
- åŠ å¯†è´§å¸: $COINS_COUNT ä¸ª
- äº¤æ˜“æ‰€: $EXCHANGES_COUNT ä¸ª
- æ›´æ–°æ—¶é—´: $TIMESTAMP
- æ•°æ®ç‰ˆæœ¬: 2.0-enhanced"
        fi
        
        git commit -m "$COMMIT_MSG"
        
    - name: æ¨é€æ›´æ”¹
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        
    - name: éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… æ•°æ®æ›´æ–°å’Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ğŸŒ ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…æ›´æ–°: https://nexdra-max.github.io/crypto/"
        else
          echo "âŒ æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
        
  # æ•°æ®è´¨é‡æ£€æŸ¥ä»»åŠ¡
  data-quality-check:
    runs-on: ubuntu-latest
    needs: update-crypto-data
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ•°æ®è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ” å¼€å§‹æ•°æ®è´¨é‡æ£€æŸ¥..."
        
        # æ£€æŸ¥å¿…è¦çš„æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        REQUIRED_FILES=(
          "data/enhanced-market-data.json"
          "data/advanced-exchanges.json" 
          "data/smart-news.json"
          "data/advanced-arbitrage.json"
          "data/last-updated.json"
        )
        
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘ä»¥ä¸‹æ•°æ®æ–‡ä»¶:"
          printf '%s\n' "${MISSING_FILES[@]}"
          exit 1
        fi
        
        # æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -s "$file" ]; then
            echo "âŒ æ•°æ®æ–‡ä»¶ä¸ºç©º: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æœ‰æ•ˆ
        echo "ğŸ“‹ éªŒè¯JSONæ ¼å¼..."
        for file in "${REQUIRED_FILES[@]}"; do
          if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
            echo "âŒ JSONæ ¼å¼æ— æ•ˆ: $file"
            exit 1
          fi
        done
        
        echo "âœ… æ‰€æœ‰æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"
        
        # è¾“å‡ºæ•°æ®ç»Ÿè®¡
        echo "ğŸ“Š æ•°æ®ç»Ÿè®¡æ‘˜è¦:"
        if [ -f "data/enhanced-market-data.json" ]; then
          MARKET_COUNT=$(grep -o '"id":' data/enhanced-market-data.json | wc -l)
          echo "- å¸‚åœºæ•°æ®: $MARKET_COUNT ä¸ªå¸ç§"
        fi
        
        if [ -f "data/advanced-exchanges.json" ]; then
          EXCHANGE_COUNT=$(grep -o '"id":' data/advanced-exchanges.json | wc -l)
          echo "- äº¤æ˜“æ‰€æ•°æ®: $EXCHANGE_COUNT ä¸ªäº¤æ˜“æ‰€"
        fi
        
        if [ -f "data/smart-news.json" ]; then
          NEWS_COUNT=$(grep -o '"id":' data/smart-news.json | wc -l)
          echo "- æ–°é—»æ•°æ®: $NEWS_COUNT æ¡æ–°é—»"
        fi
        
        if [ -f "data/advanced-arbitrage.json" ]; then
          ARBITRAGE_COUNT=$(grep -o '"coin":' data/advanced-arbitrage.json | wc -l)
          echo "- å¥—åˆ©æœºä¼š: $ARBITRAGE_COUNT ä¸ªæœºä¼š"
        fi