name: çœŸå®æ•°æ®æ›´æ–°

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œè·å–çœŸå®æ•°æ®
    - cron: '0 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-real-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        cd .github/scripts
        npm init -y
        npm install axios
        
    - name: è¿è¡ŒçœŸå®æ•°æ®è·å–è„šæœ¬
      run: |
        cd .github/scripts
        echo "ğŸš€ å¼€å§‹è·å–çœŸå®åŠ å¯†è´§å¸æ•°æ®..."
        node real-data-fetcher.js
        echo "âœ… çœŸå®æ•°æ®è·å–å®Œæˆ"
        
    - name: éªŒè¯æ•°æ®æ–‡ä»¶
      run: |
        echo "ğŸ“‹ éªŒè¯ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶..."
        ls -la data/
        echo "ğŸ“Š æ£€æŸ¥å¸‚åœºæ•°æ®..."
        if [ -f "data/coins-market.json" ]; then
          echo "âœ… å¸‚åœºæ•°æ®æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“ˆ æ•°æ®æ¡ç›®æ•°: $(cat data/coins-market.json | jq '. | length')"
        else
          echo "âŒ å¸‚åœºæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ¢ æ£€æŸ¥äº¤æ˜“æ‰€æ•°æ®..."
        if [ -f "data/exchanges.json" ]; then
          echo "âœ… äº¤æ˜“æ‰€æ•°æ®æ–‡ä»¶å­˜åœ¨"
          echo "ğŸª äº¤æ˜“æ‰€æ•°é‡: $(cat data/exchanges.json | jq '. | length')"
        else
          echo "âŒ äº¤æ˜“æ‰€æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ’° æ£€æŸ¥å¥—åˆ©æ•°æ®..."
        if [ -f "data/arbitrage-opportunities.json" ]; then
          echo "âœ… å¥—åˆ©æ•°æ®æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ”„ å¥—åˆ©æœºä¼šæ•°: $(cat data/arbitrage-opportunities.json | jq '. | length')"
        else
          echo "âŒ å¥—åˆ©æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: æäº¤å¹¶æ¨é€æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Real Data"
        git add data/
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "ğŸ“ å‘ç°æ•°æ®å˜åŒ–ï¼Œæäº¤æ›´æ–°..."
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°çœŸå®åŠ å¯†è´§å¸æ•°æ® - $(date '+%Y-%m-%d %H:%M:%S UTC')

ğŸ“Š æ•°æ®æ¥æº: CoinGecko API (çœŸå®æ•°æ®)
â° æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
ğŸ”— æ•°æ®ç±»å‹: å®æ—¶å¸‚åœºæ•°æ®ã€äº¤æ˜“æ‰€ä¿¡æ¯ã€å¥—åˆ©æœºä¼š
âœ… æ•°æ®çŠ¶æ€: å·²éªŒè¯"
          git push
          echo "âœ… çœŸå®æ•°æ®å·²æˆåŠŸæ¨é€åˆ°ä»“åº“"
        fi
        
    - name: ç”Ÿæˆæ•°æ®æŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆæ•°æ®æ›´æ–°æŠ¥å‘Š..."
        echo "## çœŸå®æ•°æ®æ›´æ–°æŠ¥å‘Š - $(date '+%Y-%m-%d %H:%M:%S UTC')" > data-report.md
        echo "" >> data-report.md
        echo "### ğŸ“Š æ•°æ®ç»Ÿè®¡" >> data-report.md
        
        if [ -f "data/coins-market.json" ]; then
          COIN_COUNT=$(cat data/coins-market.json | jq '. | length')
          echo "- ğŸª™ åŠ å¯†è´§å¸æ•°é‡: $COIN_COUNT" >> data-report.md
        fi
        
        if [ -f "data/exchanges.json" ]; then
          EXCHANGE_COUNT=$(cat data/exchanges.json | jq '. | length')
          echo "- ğŸ¢ äº¤æ˜“æ‰€æ•°é‡: $EXCHANGE_COUNT" >> data-report.md
        fi
        
        if [ -f "data/arbitrage-opportunities.json" ]; then
          ARBITRAGE_COUNT=$(cat data/arbitrage-opportunities.json | jq '. | length')
          echo "- ğŸ’° å¥—åˆ©æœºä¼š: $ARBITRAGE_COUNT" >> data-report.md
        fi
        
        echo "" >> data-report.md
        echo "### ğŸ”— æ•°æ®æ¥æº" >> data-report.md
        echo "- API: CoinGecko (https://api.coingecko.com)" >> data-report.md
        echo "- æ•°æ®ç±»å‹: çœŸå®å¸‚åœºæ•°æ®" >> data-report.md
        echo "- æ›´æ–°é¢‘ç‡: æ¯å°æ—¶" >> data-report.md
        echo "- æ•°æ®éªŒè¯: å·²é€šè¿‡" >> data-report.md
        
        echo "ğŸ“‹ æ•°æ®æŠ¥å‘Šå·²ç”Ÿæˆ:"
        cat data-report.md