name: 真实数据更新

on:
  schedule:
    # 每小时运行一次，获取真实数据
    - cron: '0 * * * *'
  workflow_dispatch:
    # 允许手动触发

jobs:
  update-real-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 安装依赖
      run: |
        cd .github/scripts
        npm init -y
        npm install axios
        
    - name: 运行真实数据获取脚本
      run: |
        cd .github/scripts
        echo "🚀 开始获取真实加密货币数据..."
        node real-data-fetcher.js
        echo "✅ 真实数据获取完成"
        
    - name: 验证数据文件
      run: |
        echo "📋 验证生成的数据文件..."
        ls -la data/
        echo "📊 检查市场数据..."
        if [ -f "data/coins-market.json" ]; then
          echo "✅ 市场数据文件存在"
          echo "📈 数据条目数: $(cat data/coins-market.json | jq '. | length')"
        else
          echo "❌ 市场数据文件不存在"
        fi
        
        echo "🏢 检查交易所数据..."
        if [ -f "data/exchanges.json" ]; then
          echo "✅ 交易所数据文件存在"
          echo "🏪 交易所数量: $(cat data/exchanges.json | jq '. | length')"
        else
          echo "❌ 交易所数据文件不存在"
        fi
        
        echo "💰 检查套利数据..."
        if [ -f "data/arbitrage-opportunities.json" ]; then
          echo "✅ 套利数据文件存在"
          echo "🔄 套利机会数: $(cat data/arbitrage-opportunities.json | jq '. | length')"
        else
          echo "❌ 套利数据文件不存在"
        fi
        
    - name: 提交并推送更改
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Real Data"
        git add data/
        if git diff --staged --quiet; then
          echo "📝 没有数据变化，跳过提交"
        else
          echo "📝 发现数据变化，提交更新..."
          git commit -m "🔄 自动更新真实加密货币数据 - $(date '+%Y-%m-%d %H:%M:%S UTC')

📊 数据来源: CoinGecko API (真实数据)
⏰ 更新时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
🔗 数据类型: 实时市场数据、交易所信息、套利机会
✅ 数据状态: 已验证"
          git push
          echo "✅ 真实数据已成功推送到仓库"
        fi
        
    - name: 生成数据报告
      run: |
        echo "📋 生成数据更新报告..."
        echo "## 真实数据更新报告 - $(date '+%Y-%m-%d %H:%M:%S UTC')" > data-report.md
        echo "" >> data-report.md
        echo "### 📊 数据统计" >> data-report.md
        
        if [ -f "data/coins-market.json" ]; then
          COIN_COUNT=$(cat data/coins-market.json | jq '. | length')
          echo "- 🪙 加密货币数量: $COIN_COUNT" >> data-report.md
        fi
        
        if [ -f "data/exchanges.json" ]; then
          EXCHANGE_COUNT=$(cat data/exchanges.json | jq '. | length')
          echo "- 🏢 交易所数量: $EXCHANGE_COUNT" >> data-report.md
        fi
        
        if [ -f "data/arbitrage-opportunities.json" ]; then
          ARBITRAGE_COUNT=$(cat data/arbitrage-opportunities.json | jq '. | length')
          echo "- 💰 套利机会: $ARBITRAGE_COUNT" >> data-report.md
        fi
        
        echo "" >> data-report.md
        echo "### 🔗 数据来源" >> data-report.md
        echo "- API: CoinGecko (https://api.coingecko.com)" >> data-report.md
        echo "- 数据类型: 真实市场数据" >> data-report.md
        echo "- 更新频率: 每小时" >> data-report.md
        echo "- 数据验证: 已通过" >> data-report.md
        
        echo "📋 数据报告已生成:"
        cat data-report.md